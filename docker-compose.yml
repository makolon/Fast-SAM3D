x-fastsam3d-build: &fastsam3d-build
  context: .
  dockerfile: Dockerfile
  args:
    FASTSAM3D_PATH_ARG: ${FASTSAM3D_PATH:-/workspace}

x-fastsam3d-environment: &fastsam3d-environment
  OMNI_KIT_ALLOW_ROOT: "1"
  TERM: ${TERM:-xterm-256color}
  XDG_RUNTIME_DIR: /tmp/runtime-root
  NVIDIA_DRIVER_CAPABILITIES: compute,utility,graphics,display,video
  NVIDIA_VISIBLE_DEVICES: all
  FASTSAM3D_PATH: ${FASTSAM3D_PATH:-/workspace}
  UV_PROJECT_ENVIRONMENT: /workspace/.venv
  PIP_EXTRA_INDEX_URL: "https://pypi.ngc.nvidia.com https://download.pytorch.org/whl/cu121"
  PIP_FIND_LINKS: "https://nvidia-kaolin.s3.us-east-2.amazonaws.com/torch-2.5.1_cu121.html"
  UV_FIND_LINKS: "https://nvidia-kaolin.s3.us-east-2.amazonaws.com/torch-2.5.1_cu121.html"
  TORCH_HOME: /workspace/checkpoints/torch-cache
  KIT_USE_EGL: "1"
  DISPLAY: ""

x-fastsam3d-service: &fastsam3d-service
  build: *fastsam3d-build
  image: fastsam3d:latest
  gpus:
    - count: all
      capabilities: [gpu]
  shm_size: "16gb"
  ipc: host
  network_mode: host
  working_dir: /workspace
  volumes:
    - type: bind
      source: ./
      target: /workspace
  stdin_open: true
  tty: true
  entrypoint: ["bash"]

services:
  fastsam3d:
    <<: *fastsam3d-service
    container_name: fastsam3d
    environment:
      <<: *fastsam3d-environment

  fastsam3d_x11:
    <<: *fastsam3d-service
    container_name: fastsam3d_x11
    environment:
      <<: *fastsam3d-environment
      DISPLAY: ${DISPLAY:-:0}
      XAUTHORITY: /root/.Xauthority
      QT_X11_NO_MITSHM: "1"
      KIT_USE_EGL: "0"
    volumes:
      - type: bind
        source: ./
        target: /workspace
      - type: bind
        source: /tmp/.X11-unix
        target: /tmp/.X11-unix
      - type: bind
        source: ${XAUTHORITY:-/tmp/.Xauthority}
        target: /root/.Xauthority
        read_only: true
    profiles: ["x11"]

  desktop:
    image: ghcr.io/matsuolab/virtual_desktop:latest
    container_name: fastsam3d_desktop
    gpus:
      - count: all
        capabilities: [gpu]
    environment:
      <<: *fastsam3d-environment
      DISPLAY: ${DISPLAY:-:20}
      QT_X11_NO_MITSHM: "1"
    ports:
      - "${WEB_PORT:-6080}:6080"
    volumes:
      - "/tmp/.X11-unix:/tmp/.X11-unix:rw"
    security_opt:
      - seccomp:unconfined
    shm_size: "2gb"
    ipc: host
    profiles: ["desktop"]
